<?xml version="1.0" encoding="UTF-8"?>

<!-- $This file is distributed under the terms of the license in /doc/license.txt$ -->

<!-- ====================================================================== 
     Build script for the Vivo Products.
                   
     jeb228                                                                
     ======================================================================-->
<project name="vivoProduct" default="describe">

	<!--
     This script should not be run on its own. 
     It should only be run from the build script of an individual Product.
    -->
	<fail>
		<condition>
			<equals arg1="${ant.file.vivoProduct}" arg2="${ant.file}" />
		</condition>
        This script should not be run by itself.
        It should be invoked from the build script of a Vivo product.
    </fail>

	<fail unless="inner.basedir"
	      message="The build script for the product must define a value for inner.basedir" />

	<!-- 
		The build directory goes in the product directory. 
		Everything else hangs from the build directory. 
	-->
	<property name="build.dir" location="./.build" />
	<property name="appbase.dir" location="${build.dir}/appBase" />

	<dirname property="vivoProduct.basedir" file="${ant.file.vivoProduct}" />
	<path id="anttasks.classpath">
		<pathelement location="${vivoProduct.basedir}/../utilities/anttasks/classes" />
	</path>

	<!-- - - - - - - - - - - - - - - - - - 
          custom Ant types                      
         - - - - - - - - - - - - - - - - - -->
	<typedef name="dirDifference"
	         classname="edu.cornell.mannlib.vitro.utilities.anttasks.DirDifferenceResourceCollection"
	         classpathref="anttasks.classpath" />
	<typedef name="optionalDir"
	         classname="edu.cornell.mannlib.vitro.utilities.anttasks.OptionalDirResourceCollection"
	         classpathref="anttasks.classpath" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: product-prepare                      
         - - - - - - - - - - - - - - - - - -->
	<target name="product-prepare">
		<mkdir dir="${appbase.dir}" />
		<mkdir dir="${appbase.dir}/web" />
		<mkdir dir="${appbase.dir}/src" />
		<mkdir dir="${appbase.dir}/test" />

		<copy todir="${appbase.dir}/web">
			<dirDifference primary="${inner.basedir}/web" blocking="${product.modifications.dir}" />
		</copy>
		<copy todir="${appbase.dir}/web">
			<fileset dir="${product.modifications.dir}" />
		</copy>

		<copy todir="${appbase.dir}/config">
			<fileset dir="${inner.basedir}/config" />
		</copy>

		<copy todir="${appbase.dir}/src">
			<dirDifference primary="${inner.basedir}/src"
			               blocking="./src"
			               blockingOptional="true" />
		</copy>
		<copy todir="${appbase.dir}/src">
			<optionalDir primary="./src" />
		</copy>

		<copy todir="${appbase.dir}/lib">
			<dirDifference primary="${inner.basedir}/lib"
			               blocking="./lib"
			               blockingOptional="true" />
		</copy>
		<copy todir="${appbase.dir}/lib">
			<optionalDir primary="./lib" />
		</copy>

		<copy todir="${appbase.dir}/test">
			<dirDifference primary="${inner.basedir}/test"
			               blocking="./test"
			               blockingOptional="true" />
		</copy>
		<copy todir="${appbase.dir}/test">
			<optionalDir primary="./test" />
		</copy>

		<copy todir="${appbase.dir}/test">
			<dirDifference primary="${inner.basedir}/test"
			               blocking="./test"
			               blockingOptional="true" />
		</copy>
		<copy todir="${appbase.dir}/test">
			<optionalDir primary="./test" />
		</copy>

		<copy todir="${appbase.dir}/themes">
			<optionalDir primary="./themes" />
		</copy>

		<copy tofile="${appbase.dir}/context.xml" file="${inner.basedir}/context.xml" />
	</target>
	<!-- ================================= 
          target: describe              
         ================================= -->
	<target name="describe" description="--> Describe the targets (this is the default).">
		<innercall target="describe" />
	</target>

	<!-- ================================= 
          target: all              
         ================================= -->
	<target name="all" depends="clean, deploy" description="--> Run 'clean', then 'deploy'" />

	<!-- ================================= 
          target: clean              
         ================================= -->
	<target name="clean" description="--> Delete all artifacts.">
		<innercall target="clean" />
	</target>

	<!-- ================================= 
          target: deploy              
         ================================= -->
	<target name="deploy"
	        depends="product-prepare"
	        description="--> Build the app and install in Tomcat">
		<innercall target="deploy" />
	</target>

	<!-- ================================= 
          target: compile              
         ================================= -->
	<target name="compile" depends="product-prepare" description="--> Compile Java sources.">
		<innercall target="compile" />
	</target>

	<!-- ================================= 
          target: test              
         ================================= -->
	<target name="test" depends="product-prepare" description="--> Run JUnit tests">
		<innercall target="test" />
	</target>

	<!-- ================================= 
	      target: revisionInfo              
	     ================================= -->
	<target name="revisionInfo"
	        depends="product-prepare"
	        description="--> Store revision info in build">
		<innercall target="revisionInfo" />
		<antcall target="productRevisionInfo" />
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
	      target: productRevisionInfo                      
	     - - - - - - - - - - - - - - - - - -->
	<target name="productRevisionInfo" unless="skipinfo">
		<property name="revisionInfo.product.dir" location="${ant.file}/.." />
		<property name="revisionInfo.build.file" location="${war-resources.dir}/revisionInfo.txt" />

		<java classname="edu.cornell.mannlib.vitro.utilities.revisioninfo.RevisionInfoBuilder"
		      fork="no"
		      failonerror="true">
			<classpath refid="test.run.classpath" />
			<arg value="${ant.project.name}" />
			<arg file="${revisionInfo.product.dir}" />
			<arg file="${revisionInfo.build.file}" />
		</java>
	</target>

	<!-- ================================= 
          target: war              
         ================================= -->
	<target name="war"
	        depends="product-prepare"
	        description="--> Build the app and create a WAR file">
		<innercall target="war" />
	</target>

	<!-- 
	===========================================================================
	===========================================================================
	===========================================================================
	NOT YET USING ANYTHING BELOW HERE
	===========================================================================
	===========================================================================
	===========================================================================
	-->

	<!-- Is there a "src" directory in the product? -->
	<property name="product.source.dir" location="./src" />
	<available property="product.sources.exist" file="${product.source.dir}" />

	<!-- Is there a "test" directory in the product? -->
	<property name="product.test.dir" location="./test" />
	<available property="product.tests.exist" file="${product.test.dir}" />

	<!-- Is there a "themes" directory in the product? -->
	<property name="product.themes.dir" location="./themes" />
	<available property="product.themes.exist" file="${product.themes.dir}" />

	<!-- Is there a modifications directory in the product? -->
	<property name="product.modifications.dir" location="./modifications" />
	<available property="product.modifications.exist" file="${product.modifications.dir}" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: productPrepare                      
         - - - - - - - - - - - - - - - - - -->
	<target name="productPrepare">
		<antcall target="prepareThemes" />
		<antcall target="prepareModifications" />
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: prepareThemes                      
         - - - - - - - - - - - - - - - - - -->
	<target name="prepareThemes" if="product.themes.exist">
		<copy todir="${build.dir}/war/themes" overwrite="true">
			<fileset dir="${product.themes.dir}" />
		</copy>
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: prepareModifications                      
         - - - - - - - - - - - - - - - - - -->
	<target name="prepareModifications" if="product.modifications.exist">
		<copy todir="${build.dir}/war" overwrite="true">
			<fileset dir="${product.modifications.dir}" />
		</copy>
	</target>


	<!-- ================================= 
          target: jar              
         ================================= -->
	<target name="jar" depends="revisionInfo" description="--> Build the app and create a JAR file">
		<jar basedir="${build.dir}/war/WEB-INF/classes"
		     destfile="${build.dir}/${webapp.name}.jar" />
	</target>

	<!-- ================================= 
          target: licenser             
          
          In regular use, checks that all appropriate source files have license tags.
          At release time, applies license text to source files.
          
          NOTE: don't override licenser.properties.file from the command line.
          Instead, override licenser.core.properties.file and licenser.product.properties.file
         ================================= -->
	<target name="licenser" description="--> Check source files for licensing tags">
		<!-- Once for the product... -->
		<innercall target="licenser">
			<property name="licenser.properties.file" value="${licenser.product.properties.file}" />
			<property name="licenser.label" value="${ant.project.name}" />
		</innercall>

		<!-- ...and once for the core. -->
		<condition property="licenser.properties.file" value="${licenser.core.properties.file}">
			<isset property="licenser.core.properties.file" />
		</condition>
		<innercall target="licenser">
			<propertyset>
				<propertyref name="licenser.properties.file" />
			</propertyset>
		</innercall>
	</target>

	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	     MACROS
         - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<!--
		Call a target in the inner script.
	-->
	<macrodef name="innercall">
		<attribute name="target" />
		<element name="additionalProperties" implicit="yes" optional="true" />
		<sequential>
			<ant dir="${inner.basedir}" inheritall="false">
				<!-- pass the properties that are needed. -->
				<propertyset>
					<propertyref name="build.dir" />
					<propertyref name="appbase.dir" />
					<propertyref name="skip.core.themes" />
					<propertyref name="deploy.properties.file" />
				</propertyset>
				<additionalProperties />
				<target name="@{target}" />
			</ant>
		</sequential>
	</macrodef>
</project>
